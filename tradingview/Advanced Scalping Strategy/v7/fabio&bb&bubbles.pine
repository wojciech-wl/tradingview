// @version=6
strategy("Fabio",
     overlay=true,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=1,
     pyramiding=1,
     max_labels_count=500)

// === INPUTS ===
use_bias       = input.bool(true,  "Use VWAP Bias")

// Order Block settings
ob_strength    = input.float(1.5,   "OB Range Multiplier (ATR)", minval=0.5)
ob_max_age     = input.int(30,      "Max OB Age (bars)")
ob_buffer      = input.float(0.5,   "OB Price Buffer (%)", step=0.1)

// Volume / Momentum settings
vol_period     = input.int(20,      "Volume SMA Period")
vol_mult       = input.float(2.0,   "Volume Spike Multiplier", step=0.1)
body_thresh    = input.float(0.6,   "Impulse Body/Range Threshold", step=0.1)

// Stop-loss / trailing
atr_period     = input.int(14,      "ATR Period")
sl_buffer      = input.float(1.0,   "SL ATR Multiplier", step=0.1)
trail_vol_mult = input.float(2.0,   "Trail Volume Spike Multiplier", step=0.1)

// ---- Bollinger Bands (display only) ----
show_bb        = input.bool(true,   "Show Bollinger Bands")
bb_length      = input.int(50,      "BB Length (swing)", minval=5)
bb_mult        = input.float(2.0,   "BB Multiplier", step=0.1, minval=0.5, maxval=5.0)

// ---- Delta bubbles (order-flow proxy) ----
show_bubbles = input.bool(true,  "Show Delta Bubbles")
// prÃ³g do FILTRA WEJÅšÄ† (delta musi go przekroczyÄ‡)
delta_min    = input.float(5000.0, "Delta threshold for entries (shares)", step=100.0, minval=0.0)
// prÃ³g do WYÅšWIETLANIA bÄ…bli (moÅ¼e byÄ‡ niÅ¼szy, np. 3000)
bubble_min   = input.float(3000.0, "Bubble display threshold (shares)",    step=100.0, minval=0.0)

// === INDICATORS ===
vwap_val = ta.vwap(hl2)
bias     = use_bias ? (close > vwap_val ? 1 : close < vwap_val ? -1 : 0) : 0
plot(use_bias ? vwap_val : na, "VWAP", color=color.orange)
atr      = ta.atr(atr_period)

// ---- BB calc & plots ----
bb_basis = ta.sma(close, bb_length)
bb_dev   = bb_mult * ta.stdev(close, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev
plot(show_bb ? bb_basis : na, "BB Basis", color=color.new(color.blue, 0))
pBBu = plot(show_bb ? bb_upper : na, "BB Upper", color=color.new(color.blue, 50))
pBBl = plot(show_bb ? bb_lower : na, "BB Lower", color=color.new(color.blue, 50))
fill(pBBu, pBBl, color=show_bb ? color.new(color.blue, 90) : na)

// === ORDER BLOCKS ===
var float last_bull_ob = na
var int   bull_ob_bar  = na
var float last_bear_ob = na
var int   bear_ob_bar  = na
isBullOB = (high - low) > atr * ob_strength and close > open
isBearOB = (high - low) > atr * ob_strength and close < open
if isBullOB
    last_bull_ob := low
    bull_ob_bar  := bar_index
if isBearOB
    last_bear_ob := high
    bear_ob_bar  := bar_index

bull_ob_valid = not na(last_bull_ob) and (bar_index - bull_ob_bar) <= ob_max_age
bear_ob_valid = not na(last_bear_ob) and (bar_index - bear_ob_bar) <= ob_max_age
ob_buffer_px  = atr * (ob_buffer / 100)
bull_near     = bull_ob_valid and math.abs(low - last_bull_ob) <= ob_buffer_px
bear_near     = bear_ob_valid and math.abs(high - last_bear_ob) <= ob_buffer_px

// === VOLUME / IMPULSE ===
vol_sma      = ta.sma(volume, vol_period)
vol_spike    = volume > vol_sma * vol_mult
rng          = math.max(high - low, syminfo.mintick)
body_ratio   = math.abs(close - open) / rng
impulse_up   = vol_spike and close > open and body_ratio > body_thresh
impulse_down = vol_spike and close < open and body_ratio > body_thresh

// === DELTA (body priority + tick-rule fallback) ===
// 1) jeÅ›li korpus â‰  0 â†’ kolor wg korpusu Å›wiecy
// 2) jeÅ›li doji â†’ uÅ¼yj tick-rule (zmiany vs close[1])
// 3) jeÅ›li nadal 0 â†’ uÅ¼yj poprzedniego znaku
var float _sign = 0.0
body_sign = close > open ? 1 : close < open ? -1 : 0
chg = ta.change(close)
tick_sign = chg > 0 ? 1 : chg < 0 ? -1 : 0
_sign := body_sign != 0 ? body_sign : (tick_sign != 0 ? tick_sign : nz(_sign[1], 0))
delta = _sign * volume
absDelta = math.abs(delta)

// === BUBBLES: 5 rozmiarÃ³w wg przedziaÅ‚Ã³w (3â€“5k, 5â€“10k, 10â€“25k, 25â€“50k, 50k+) ===
if show_bubbles and absDelta >= bubble_min
    bsize = size.tiny
    if absDelta >= 50000
        bsize := size.huge
    else if absDelta >= 25000
        bsize := size.large
    else if absDelta >= 10000
        bsize := size.normal
    else if absDelta >= 5000
        bsize := size.small
    bcolor = delta > 0 ? color.new(color.lime, 70) : color.new(color.red, 70)
    label.new(bar_index, close, "", style=label.style_circle, size=bsize, color=bcolor, textcolor=bcolor)

// === FOLLOW-UP ===
follow_up_up   = impulse_up[1]   and close > open
follow_up_down = impulse_down[1] and close < open

// === ENTRIES (delta jako filtr) ===
bull_entry = (bias >= 0) and impulse_up   and bull_near and follow_up_up   and (delta >  delta_min)
bear_entry = (bias <= 0) and impulse_down and bear_near and follow_up_down and (delta < -delta_min)

// === POSITION MANAGEMENT ===
var float sl_level = na
if bull_entry
    strategy.entry("Long", strategy.long)
    sl_level := last_bull_ob - atr * sl_buffer
if bear_entry
    strategy.entry("Short", strategy.short)
    sl_level := last_bear_ob + atr * sl_buffer
if not na(sl_level)
    strategy.exit("Exit", stop=sl_level)
if strategy.position_size > 0 and volume > vol_sma * trail_vol_mult
    new_sl    = close - atr * sl_buffer
    sl_level := math.max(sl_level, new_sl)
    strategy.exit("Trail Long", stop=sl_level)
if strategy.position_size < 0 and volume > vol_sma * trail_vol_mult
    new_sl    = close + atr * sl_buffer
    sl_level := math.min(sl_level, new_sl)
    strategy.exit("Trail Short", stop=sl_level)
if strategy.position_size == 0
    sl_level := na

// === PLOTS & SIGNALS ===
plotshape(isBullOB,     title="Bull OB",          location=location.belowbar, color=color.new(color.green,80), style=shape.circle,      size=size.tiny)
plotshape(isBearOB,     title="Bear OB",          location=location.abovebar, color=color.new(color.red,80),   style=shape.circle,      size=size.tiny)
plotshape(impulse_up,   title="Impulse Candle",   location=location.abovebar, color=color.new(color.yellow,0), style=shape.square,      size=size.tiny, text="âš¡")
plotshape(follow_up_up, title="Follow-up Candle", location=location.belowbar, color=color.new(color.blue,0),   style=shape.triangleup, size=size.small, text="âœ”")
plotshape(bull_entry,   title="Long Entry",       location=location.belowbar, color=color.green,          style=shape.triangleup,  size=size.large)
plotshape(bear_entry,   title="Short Entry",      location=location.abovebar, color=color.red,            style=shape.triangledown,size=size.large)

// === LEGEND ===
var table legend = table.new(position.top_right, 2, 7, border_color=color.gray, frame_color=color.gray)
if barstate.islast
    table.cell(legend, 0, 0, "Symbol",              text_color=color.white, bgcolor=color.gray)
    table.cell(legend, 1, 0, "Meaning",             text_color=color.white, bgcolor=color.gray)
    table.cell(legend, 0, 1, "ðŸŸ¢â—¯ Bull OB",         text_color=color.green)
    table.cell(legend, 1, 1, "Order Block support")
    table.cell(legend, 0, 2, "ðŸ”´â—¯ Bear OB",         text_color=color.red)
    table.cell(legend, 1, 2, "Order Block resistance")
    table.cell(legend, 0, 3, "âš¡",                   text_color=color.yellow)
    table.cell(legend, 1, 3, "Impulse volume spike")
    table.cell(legend, 0, 4, "âœ”",                   text_color=color.blue)
    table.cell(legend, 1, 4, "Follow-up confirmation")
    table.cell(legend, 0, 5, "â–²",                   text_color=color.green)
    table.cell(legend, 1, 5, "Buy / Sell signals")
    table.cell(legend, 0, 6, "BB",                  text_color=color.blue)
    table.cell(legend, 1, 6, "Len 50, Mult " + str.tostring(bb_mult))

// === END ===
