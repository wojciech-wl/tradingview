//@version=6
indicator("Order Flow Delta Tracker ++ (v6, daily CVD, v9 preview)", overlay=false, max_labels_count=500)

// ===== Inputs =====
sign_mode     = input.string("CandleColor", "Delta sign mode", options=["CandleColor", "Body+Tick"])
rolling_len   = input.int(35,  "Rolling CumDelta length", minval=2) // v9: reduced from 50 -> 35 for faster local response
show_delta    = input.bool(true,   "Show Delta columns")
show_cvd      = input.bool(true,   "Show CVD (daily reset)")
cvd_smooth    = input.int(0,    "CVD smoothing (SMA bars)", minval=0)
show_rolling  = input.bool(true,   "Show Rolling CumDelta")
// v9 addition: Immediate (impulse) aggression line (EMA of delta * scale) – purely visual, NOT used in CVD/divergence
show_immediate      = input.bool(true,  "Show Immediate Δ (EMA)")
immediate_len       = input.int(2,      "Immediate Δ EMA length", minval=1, maxval=10)
immediate_scale     = input.float(5.0,  "Immediate Δ scale factor", step=0.5, minval=0.1, maxval=100) // v9: reduced (was 10→50 test, now 5)
immediate_auto_scale= input.bool(false, "Immediate Δ auto scale (normalize)")
immediate_auto_len  = input.int(50,     "Immediate Δ auto scale lookback", minval=10, maxval=500)
show_zero     = input.bool(true,   "Show Zero line")
show_vwap     = input.bool(true,   "Show VWAP")
show_price    = input.bool(false,  "Show Price")
show_norm     = input.bool(false,  "Show Normalized Price (0–100)")
show_absorb   = input.bool(true,   "Show Absorption signal")
show_spikes   = input.bool(true,   "Show Delta Spikes")
div_window    = input.int(10,   "Divergence lookback", minval=2)
imb_mult      = input.float(2.0, "Imbalance body ratio", step=0.1) // (high-close) > mult*(close-open) for red, etc.

// ===== Delta sign =====
float delta = na
if sign_mode == "CandleColor"
    // identycznie jak w Twoim v5
    isUp   = close > open
    isDown = close < open
    buyVolume  = isUp   ? volume : 0.0
    sellVolume = isDown ? volume : 0.0
    delta := buyVolume - sellVolume
else
    // Body priority + tick-rule fallback (mniejsza liczba "doji=0")
    var float _sign = 0.0
    body_sign = close > open ? 1 : close < open ? -1 : 0
    chg       = ta.change(close)
    tick_sign = chg > 0 ? 1 : chg < 0 ? -1 : 0
    _sign     := body_sign != 0 ? body_sign : (tick_sign != 0 ? tick_sign : nz(_sign[1], 0))
    delta := _sign * volume

// ===== Rolling CumDelta (identyczna logika jak u Ciebie) =====
rolling_cum = ta.cum(delta) - nz(ta.cum(delta)[rolling_len]) // Local cumulative delta (window)

// ===== Immediate Aggression (Momentum Accumulator with Streak Boost) =====
// Dynamic momentum: accumulates during streaks, decays during reversals - purely visual.

// Count consecutive positive/negative deltas (streak detection)
var int pos_streak = 0
var int neg_streak = 0
pos_streak := delta > 0 ? pos_streak + 1 : 0
neg_streak := delta < 0 ? neg_streak + 1 : 0

// Momentum accumulator - builds during streaks, decays faster than EMA during reversals
var float momentum_acc = 0.0
streak_boost = math.max(pos_streak, neg_streak) * 0.3  // 30% boost per consecutive bar
avg_delta = ta.sma(math.abs(delta), 20)  // Recent average delta for scaling

// During streak: accumulate aggressively, During reversal: decay fast
if (delta > 0 and delta[1] <= 0) or (delta < 0 and delta[1] >= 0)
    // Direction change - reset but keep some momentum
    momentum_acc := delta * 0.7
else
    // Same direction - accumulate with streak boost
    momentum_acc := momentum_acc * 0.85 + delta * (1.0 + streak_boost)

// Scale to be visible - reduced from 0.56x to 0.19x (0.56/3)
base_scale = 0.19
immediate_norm_den = immediate_auto_scale ? math.max(ta.sma(math.abs(momentum_acc), immediate_auto_len), syminfo.mintick) : 1.0
immediate_effective_scale = immediate_auto_scale ? (immediate_scale * base_scale) / immediate_norm_den : (immediate_scale * base_scale)
immediate_plot = momentum_acc * immediate_effective_scale

// ===== Session CVD (daily reset) =====
new_day = ta.change(time("D")) != 0
var float cvd = na
cvd := barstate.isfirst ? delta : (new_day ? delta : nz(cvd[1]) + delta)
cvd_plot = cvd_smooth > 0 ? ta.sma(cvd, cvd_smooth) : cvd

// ===== Imbalance background (jak w v5 – delikatne tło) =====
imbalance = (high - close) > imb_mult * math.max(close - open, 0)  // red-leaning
bgcolor(imbalance ? color.new(color.red, 85) : na)

// ===== Absorption =====
isAbsorbing = volume > ta.sma(volume, 20) * 1.5 and math.abs(close - open) < (high - low) * 0.25
plotshape(show_absorb and isAbsorbing, title="Absorption", location=location.abovebar,
          color=color.orange, style=shape.triangledown, text="Abs")

// ===== Bearish divergence: Price HH vs CumΔ/CVD LH =====
priceHH = high > ta.highest(high, div_window)[1]
deltaLH = rolling_cum < ta.highest(rolling_cum, div_window)[1]
cvdLH   = cvd_plot    < ta.highest(cvd_plot,    div_window)[1]
plotshape(priceHH and (deltaLH or cvdLH), title="Bearish Δ Divergence",
          location=location.abovebar, style=shape.labeldown, color=color.red, text="Δ Divergence")

// ===== VWAP / Price / Normalized Price (opcjonalne) =====
vwap = ta.vwap(close)
plot(show_vwap  ? vwap  : na, title="VWAP",  color=color.yellow)
plot(show_price ? close : na, title="Price", color=color.gray, linewidth=1)
norm_den = math.max(ta.highest(close, 50) - ta.lowest(close, 50), syminfo.mintick)
normalizedPrice = (close - ta.lowest(close, 50)) / norm_den * 100
plot(show_norm ? normalizedPrice : na, title="Normalized Price", color=color.gray)

// ===== Barcolor wg delty (jak w v5) =====
barcolor(show_delta ? (delta > 0 ? color.new(color.green, 30) : color.new(color.red, 30)) : na)

// ===== Delta Spike =====
deltaSpike = math.abs(delta) > ta.sma(math.abs(delta), 20) * 2
plotshape(show_spikes and deltaSpike, location=location.abovebar,
          color=color.fuchsia, style=shape.cross, title="Delta Spike", text="×")

// ===== Plots główne =====
plot(show_delta ? delta : na, title="Delta",
     style=plot.style_columns,
     color=delta >= 0 ? color.new(color.green, 0) : color.new(color.red, 0))

plot(show_rolling ? rolling_cum : na, title="Cumulative Delta (rolling)", color=color.blue, linewidth=1)
plot(show_immediate ? immediate_plot : na, title="Immediate Δ (scaled)", color=color.yellow, linewidth=1, style=plot.style_line)
plot(show_cvd ? cvd_plot : na, title="CVD (daily reset)", color=color.purple, linewidth=1)
plot(show_zero ? 0 : na, title="Zero", color=color.gray)
